angular.module("wSQL.db",["wSQL.db.config"]).factory("wSQL",["W_SQL_CONFIG","$q",function(r,n){var t=({}.hasOwnProperty,function(r){var n=0,t="",e="",u="",o=[];for(var i in r)t+=0==n?"?":",?",e+=(0==n?"? as ":",? as ")+i,u+=(0==n?"":",")+i+"=?",o.push(r[i]),++n;return{keys:Object.keys(r).join(),values:o,query:t,query_with_as:e,query_for_set:u}}),e=function(r){var n="";return r.forEach(function(r,t){n+=0===t?"?":", ?"}),n},u=function(){var r,n=!1;return{get:function(){return r},set:function(t){return r=window.openDatabase(t.name,t.version,t.sub_name,t.size),n=!0,r}}}(),o=function(r,t,e){if(!r.name||!r.version||!r.sub_name||!r.size||!t||Object.keys(t).length<=0)return console.error("WebSQLite InitInterface error: initialize params are not specified"),!1;if(u.set(r),e){console.warn("DB was cleaned");var o=[];for(var i in t)o.push((new a).drop(i));n.all(o).then(function(){for(var r in t)(new p).create(r,t[r])})}else{console.warn("DB was NOT cleaned");for(var i in t)(new p).create(i,t[i])}return f},i=function(){function r(){}return r.prototype._querySuccess=function(r,n,t){console.debug("querySuccess");try{return n.insertId,t(JSON.parse(JSON.stringify(n)))}catch(e){var u=n.rows.length,o=[];if(n.rows.length>0)for(var i=0;u>i;i++)o[i]=JSON.parse(JSON.stringify(n.rows.item(i)));return t?t(o):!0}},r.prototype._queryDB=function(r,n,t,e){var u=this;console.info(n,t),r.executeSql(n,t,function(r,n){u._querySuccess(r,n,e)},function(r){u._errorCB(r,n,t,e)})},r.prototype._errorCB=function(r,n,t,e){console.error("Error processing SQL, error & sql below:"),console.error(r),e&&e({error:r})},r.prototype.query=function(r,t){var e=n.defer(),o=this;return u.get().transaction(function(n){o._queryDB(n,r,t||[],e.resolve)},function(n){o._errorCB(n,r,e.reject)}),e.promise},r}(),p=function(){function r(){}return r.prototype.create=function(r,n){return(new i).query("CREATE TABLE IF NOT EXISTS "+r+"("+n.join()+")",[])},r}(),a=function(){function r(){}return r.prototype.drop=function(r){return(new i).query("DROP TABLE IF EXISTS "+r,[])},r}(),s=function(){function r(){}return r.prototype.insert=function(r,n){var e=t(n),u="INSERT INTO "+r+" ("+e.keys+") VALUES ("+e.query+")";return(new i).query(u,e.values)},r.prototype.batch_insert=function(r,n){var e="INSERT INTO "+r+" ("+t(n[0]).keys+")",u=[];return n.forEach(function(r,n){var o=t(r);u=u.concat(o.values),e+=0===n?" SELECT "+o.query_with_as:" UNION SELECT "+o.query}),(new i).query(e,u)},r}(),y=function(){function r(){this._sql="",this._query_data=[]}return r.prototype.select=function(r){return this._sql="SELECT "+(r?r:"*")},r.prototype.update=function(r,n){return this._sql="UPDATE "+r,n?this.set(n):this._sql},r.prototype.set=function(r){var n=t(r);return this._query_data=n.values,this._sql+=" SET "+n.query_for_set},r.prototype.delete=function(r){return this._sql="DELETE FROM "+r},r.prototype.from=function(r,n){return this._sql+=" FROM "+r+(n?" AS "+n:"")},r.prototype._where_query=function(r,n,t,e){return this._query_data.push(t),this._sql+=" "+r+" "+n+(e?e:"=")+"?"},r.prototype.where=function(r,n,t){return this._where_query("WHERE",r,n,t)},r.prototype.or=function(r,n,t){return this._where_query("OR",r,n,t)},r.prototype.and=function(r,n,t){return this._where_query("AND",r,n,t)},r.prototype._where_in_query=function(r,n,t){return this._query_data=this._query_data.concat(t),this._sql+=" "+r+" "+n+" IN ("+e(t)+")"},r.prototype.where_in=function(r,n){return this._where_in_query("WHERE",r,n)},r.prototype.or_in=function(r,n){return this._where_in_query("OR",r,n)},r.prototype.and_in=function(r,n){return this._where_in_query("AND",r,n)},r.prototype._join_query=function(r,n,t,e,u){var o=t+(u?u:" = ")+e;return this._sql+=" "+r+" JOIN "+n+" ON "+o},r.prototype.join=function(r,n,t,e){return this._join_query("INNER",r,n,t,e)},r.prototype.left_join=function(r,n,t,e){return this._join_query("LEFT",r,n,t,e)},r.prototype.order_by=function(r,n){return this._sql+=" ORDER BY "+r+(n?" DESC":"")},r.prototype.group_by=function(r){return this._sql+=" GROUP BY "+r},r.prototype.having=function(r,n,t){return this._query_data.push(n),this._sql+=" HAVING "+r+(t?t:"=")+"?"},r.prototype.limit=function(r,n){return this._sql+=" LIMIT "+r+(n?" OFFSET "+n:"")},r.prototype.query=function(){return(new i).query(this._sql,this._query_data)},r.prototype.row=function(){return this._sql+=" LIMIT 1",(new i).query(this._sql,this._query_data)},r.prototype.col=function(){this._sql+=" LIMIT 1";var r=n.defer();return(new i).query(this._sql,this._query_data).then(function(n){r.resolve(n.length>0?n[0][Object.keys(n[0])[0]]:[])},r.reject),r.promise},r}(),c=function(){function r(){this.queryBuilderAPI=new y}return r.prototype.__perform=function(r,n){var t=r,e=this;switch(r){case"where":case"where_in":case"and":case"and_in":case"or":case"or_in":t="where";break;default:t=r}var u={select:{from:function(){return e.from.apply(e,arguments)}},update:{set:function(){return e.set.apply(e,arguments)},where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)}},set:{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)}},"delete":{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)}},from:{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},join:function(){return e.join.apply(e,arguments)},left_join:function(){return e.left_join.apply(e,arguments)},order_by:function(){return e.order_by.apply(e,arguments)},group_by:function(){return e.group_by.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},where:{and:function(){return e.and.apply(e,arguments)},or:function(){return e.or.apply(e,arguments)},and_in:function(){return e.and_in.apply(e,arguments)},or_in:function(){return e.or_in.apply(e,arguments)},order_by:function(){return e.order_by.apply(e,arguments)},group_by:function(){return e.group_by.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},join:{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},join:function(){return e.join.apply(e,arguments)},left_join:function(){return e.left_join.apply(e,arguments)},order_by:function(){return e.order_by.apply(e,arguments)},group_by:function(){return e.group_by.apply(e,arguments)},having:function(){return e.having.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},group_by:{order_by:function(){return e.order_by.apply(e,arguments)},having:function(){return e.having.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},order_by:{having:function(){return e.having.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},having:{and:function(){return e.and.apply(e,arguments)},or:function(){return e.or.apply(e,arguments)},and_in:function(){return e.and_in.apply(e,arguments)},or_in:function(){return e.or_in.apply(e,arguments)},order_by:function(){return e.order_by.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},limit:{query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}}};return this.queryBuilderAPI[r].apply(this.queryBuilderAPI,n),u[t]},r.prototype.select=function(){return this.__perform("select",arguments)},r.prototype.update=function(){return this.__perform("update",arguments)},r.prototype.set=function(){return this.__perform("set",arguments)},r.prototype.delete=function(){return this.__perform("delete",arguments)},r.prototype.from=function(){return this.__perform("from",arguments)},r.prototype.where=function(){return this.__perform("where",arguments)},r.prototype.where_in=function(){return this.__perform("where_in",arguments)},r.prototype.or=function(){return this.__perform("or",arguments)},r.prototype.and=function(){return this.__perform("and",arguments)},r.prototype.or_in=function(){return this.__perform("or_in",arguments)},r.prototype.and_in=function(){return this.__perform("and_in",arguments)},r.prototype.join=function(){return this.__perform("join",arguments)},r.prototype.left_join=function(){return this.__perform("join",arguments)},r.prototype.order_by=function(){return this.__perform("order_by",arguments)},r.prototype.group_by=function(){return this.__perform("group_by",arguments)},r.prototype.having=function(){return this.__perform("having",arguments)},r.prototype.limit=function(){return this.__perform("limit",arguments)},r.prototype.query=function(){return this.queryBuilderAPI.query()},r.prototype.row=function(){return this.queryBuilderAPI.row()},r.prototype.col=function(){return this.queryBuilderAPI.col()},r}(),f={select:function(r){return(new c).select(r)},update:function(r,n){return(new c).update(r,n)},insert:function(r,n){return(new s).insert(r,n)},batch_insert:function(r,n){return"string"!=typeof r?!1:n instanceof Array==!1?!1:(new s).batch_insert(r,n)},"delete":function(r){return(new c).delete(r)}};return o(r.PARAMS,r.TABLES_SQL,r.CLEAR)}]);