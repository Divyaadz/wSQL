angular.module("wSQL.db",["wSQL.db.config"]).factory("wSQL",["W_SQL_CONFIG","$q",function(n,r){var e=function(n){var r=0,e="",t="",i="",u=[];for(var o in n)e+=0==r?"?":",?",t+=(0==r?"? as ":",? as ")+o,i+=(0==r?"":",")+o+"=?",u.push(n[o]),++r;return{keys:Object.keys(n).join(),values:u,query:e,query_with_as:t,query_for_set:i}},t=function(n){var r="";return n.forEach(function(n,e){r+=0===e?"?":", ?"}),r},i=function(){var n,r=!1;return{get:function(){return n},set:function(e){return n=window.openDatabase(e.name,e.version,e.sub_name,e.size),r=!0,n}}}(),u=function(n,e,t){if(!n.name||!n.version||!n.sub_name||!n.size||!e||Object.keys(e).length<=0)return console.error("WebSQLite InitInterface error: initialize params are not specified"),!1;if(i.set(n),t){console.warn("DB was cleaned");var u=[];for(var o in e){var a=new c;u.push(a.drop(o))}r.all(u).then(function(){for(var n in e){var r=new s;r.create(n,e[n])}})}else{console.warn("DB was NOT cleaned");for(var o in e){var h=new s;h.create(o,e[o])}}return y},o=function(){var n=function(n,r,e){console.debug("querySuccess");try{return r.insertId,e(JSON.parse(JSON.stringify(r)))}catch(t){var i=r.rows.length,u=[];if(r.rows.length>0)for(var o=0;i>o;o++)u[o]=JSON.parse(JSON.stringify(r.rows.item(o)));return e?e(u):!0}},e=function(r,e,i,u){console.info(e,i),r.executeSql(e,i,function(r,e){n(r,e,u)},function(n){t(n,e,i,u)})},t=function(n,r,e,t){console.error("Error processing SQL, error & sql below:"),console.error(n),t&&t({error:n})};this.query=function(n,u){var o=r.defer();return i.get().transaction(function(r){e(r,n,u||[],o.resolve)},function(r){t(r,n,o.reject)}),o.promise}},s=function(){this.create=function(n,r){return(new o).query("CREATE TABLE IF NOT EXISTS "+n+"("+r.join()+")",[])}},c=function(){this.drop=function(n){return(new o).query("DROP TABLE IF EXISTS "+n,[])}},a=function(){var n=new h,r=this,e=function(e,t){return n[e].apply(n[e],t),{where:r.where,where_in:r.where_in,and:r.and,or:r.or,and_in:r.and_in,or_in:r.or_in,join:r.join,left_join:r.left_join,order_by:r.order_by,group_by:r.group_by,having:r.having,limit:r.limit,query:r.query,row:r.row,col:r.col}};this.select=function(){return n.select.apply(n.select,arguments),{from:r.from}},this.from=function(){return e("from",arguments)},this.where=function(){return e("where",arguments)},this.where_in=function(){return e("where_in",arguments)},this.join=function(){return e("join",arguments)},this.left_join=function(){return e("left_join",arguments)},this.order_by=function(){return e("order_by",arguments)},this.group_by=function(){return e("group_by",arguments)},this.having=function(){return e("having",arguments)},this.or=function(){return e("or",arguments)},this.and=function(){return e("and",arguments)},this.or_in=function(){return e("or_in",arguments)},this.and_in=function(){return e("and_in",arguments)},this.limit=function(){return e("limit",arguments)},this.query=n.query,this.row=n.row,this.col=n.col},h=function(){var n="",e=[],i=this;this.select=function(r){return n="SELECT "+(r?r:"*")},this.from=function(r,e){return n+=" FROM "+r+(e?" AS "+e:"")},this._where_query=function(r,t,i,u){return e.push(i),n+=" "+r+" "+t+(u?u:"=")+"?"},this.where=function(n,r,e){return i._where_query("WHERE",n,r,e)},this.or=function(n,r,e){return i._where_query("OR",n,r,e)},this.and=function(n,r,e){return i._where_query("AND",n,r,e)},this._where_in_query=function(r,i,u){return e=e.concat(u),n+=" "+r+" "+i+" IN ("+t(u)+")"},this.where_in=function(n,r){return i._where_in_query("WHERE",n,r)},this.or_in=function(n,r){return i._where_in_query("OR",n,r)},this.and_in=function(n,r){return i._where_in_query("AND",n,r)},this._join_query=function(r,e,t,i,u){var o=t+(u?u:" = ")+i;return n+=" "+r+" JOIN "+e+" ON "+o},this.join=function(n,r,e,t){return i._join_query("INNER",n,r,e,t)},this.left_join=function(n,r,e,t){return i._join_query("LEFT",n,r,e,t)},this.order_by=function(r,e){return n+=" ORDER BY "+r+(e?" DESC":"")},this.group_by=function(r){return n+=" GROUP BY "+r},this.having=function(r,t,i){return e.push(t),n+=" HAVING "+r+(i?i:"=")+"?"},this.limit=function(r,e){return n+=" LIMIT "+r+(e?" OFFSET "+e:"")},this.query=function(){return(new o).query(n,e)},this.row=function(){n+=" LIMIT 1";var r=new o;return r.query(n,e)},this.col=function(){n+=" LIMIT 1";var t=new o,i=r.defer();return t.query(n,e).then(function(n){i.resolve(n.length>0?n[0][Object.keys(n[0])[0]]:[])},i.reject),i.promise}},f=function(){this.insert=function(n,r){var t=e(r),i="INSERT INTO "+n+" ("+t.keys+") VALUES ("+t.query+")";return(new o).query(i,t.values)},this.batch_insert=function(n,r){var t="INSERT INTO "+n+" ("+e(r[0]).keys+")",i=[];return r.forEach(function(n,r){var u=e(n);i=i.concat(u.values),t+=0===r?" SELECT "+u.query_with_as:" UNION SELECT "+u.query}),(new o).query(t,i)}},_=function(){var n=new w,r=this,e=function(e,t){return n[e].apply(n[e],t),{where:r.where,where_in:r.where_in,and:r.and,or:r.or,and_in:r.and_in,or_in:r.or_in,query:r.query}};this.update=function(){return e("update",arguments)},this.where=function(){return e("where",arguments)},this.where_in=function(){return e("where_in",arguments)},this.or=function(){return e("or",arguments)},this.and=function(){return e("and",arguments)},this.or_in=function(){return e("or_in",arguments)},this.and_in=function(){return e("and_in",arguments)},this.query=n.query},w=function(){var n=this,r="",i=[];this.update=function(n,t){var u=e(t);return i=u.values,r+="UPDATE "+n+" SET "+u.query_for_set},this._where_query=function(n,e,t,u){return i.push(t),r+=" "+n+" "+e+(u?u:"=")+"?"},this.where=function(r,e,t){return n._where_query("WHERE",r,e,t)},this.or=function(r,e,t){return n._where_query("OR",r,e,t)},this.and=function(r,e,t){return n._where_query("AND",r,e,t)},this._where_in_query=function(n,e,u){return i=i.concat(u),r+=" "+n+" "+e+" IN ("+t(u)+")"},this.where_in=function(r,e){return n._where_in_query("WHERE",r,e)},this.or_in=function(r,e){return n._where_in_query("OR",r,e)},this.and_in=function(r,e){return n._where_in_query("AND",r,e)},this.query=function(){return(new o).query(r,i)}},y={select:function(n){return(new a).select(n)},update:function(n,r){return(new _).update(n,r)},insert:function(n,r){return(new f).insert(n,r)},batch_insert:function(n,r){return"string"!=typeof n?!1:r instanceof Array==!1?!1:(new f).batch_insert(n,r)},remove:function(){}};return u(n.PARAMS,n.TABLES_SQL,n.CLEAR)}]);