angular.module("wSQL",["wSQL.config"]).factory("wSQL",["W_SQL_CONFIG","$q",function(r,n){var t=function(r,n){function t(){this.constructor=r}for(var u in n)e.call(n,u)&&(r[u]=n[u]);return t.prototype=n.prototype,r.prototype=new t,r.__super__=n.prototype,r},e={}.hasOwnProperty,u=function(r){var n=0,t="",e="",u="",o=[];for(var i in r)t+=0==n?"?":",?",e+=(0==n?"? as ":",? as ")+i,u+=(0==n?"":",")+i+"=?",o.push(r[i]),++n;return{keys:Object.keys(r).join(),values:o,query:t,query_with_as:e,query_for_set:u}},o=function(r){var n="";return r.forEach(function(r,t){n+=0===t?"?":", ?"}),n},i=function(){var r,n=!1;return{get:function(){return r},set:function(t){return r=window.openDatabase(t.name,t.version,t.sub_name,t.size),n=!0,r}}}(),p=function(r,t,e){if(!r.name||!r.version||!r.sub_name||!r.size||!t||Object.keys(t).length<=0)return console.error("WebSQLite InitInterface error: initialize params are not specified"),!1;if(i.set(r),e){console.warn("DB was cleaned");var u=[];for(var o in t)u.push((new c).drop(o));n.all(u).then(function(){for(var r in t)(new s).create(r,t[r])})}else{console.warn("DB was NOT cleaned");for(var o in t)(new s).create(o,t[o])}return l},a=function(){function r(){}return r.prototype._querySuccess=function(r,n,t){console.debug("querySuccess");try{return n.insertId,t(JSON.parse(JSON.stringify(n)))}catch(e){var u=n.rows.length,o=[];if(n.rows.length>0)for(var i=0;u>i;i++)o[i]=JSON.parse(JSON.stringify(n.rows.item(i)));return t?t(o):!0}},r.prototype._queryDB=function(r,n,t,e){var u=this;console.info(n,t),r.executeSql(n,t,function(r,n){u._querySuccess(r,n,e)},function(r){u._errorCB(r,n,t,e)})},r.prototype._errorCB=function(r,n,t,e){console.error("Error processing SQL, error & sql below:"),console.error(r),e&&e({error:r})},r.prototype.query=function(r,t){var e=n.defer(),u=this;return i.get().transaction(function(n){u._queryDB(n,r,t||[],e.resolve)},function(n){u._errorCB(n,r,e.reject)}),e.promise},r}(),s=function(){function r(){}return r.prototype.create=function(r,n){return(new a).query("CREATE TABLE IF NOT EXISTS "+r+"("+n.join()+")",[])},r}(),c=function(){function r(){}return r.prototype.drop=function(r){return(new a).query("DROP TABLE IF EXISTS "+r,[])},r}(),y=function(){function r(){}return r.prototype.insert=function(r,n){var t=u(n),e="INSERT INTO "+r+" ("+t.keys+") VALUES ("+t.query+")";return(new a).query(e,t.values)},r.prototype.batch_insert=function(r,n){var t="INSERT INTO "+r+" ("+u(n[0]).keys+")",e=[];return n.forEach(function(r,n){var o=u(r);e=e.concat(o.values),t+=0===n?" SELECT "+o.query_with_as:" UNION SELECT "+o.query}),(new a).query(t,e)},r}(),_=function(){function r(){this._sql="",this._query_data=[]}return r.prototype.select=function(r){return this._sql="SELECT "+(r?r:"*")},r.prototype.update=function(r,n){return this._sql="UPDATE "+r,n?this.set(n):this._sql},r.prototype.set=function(r){var n=u(r);return this._query_data=n.values,this._sql+=" SET "+n.query_for_set},r.prototype.delete=function(r){return this._sql="DELETE FROM "+r},r.prototype.from=function(r,n){return this._sql+=" FROM "+r+(n?" AS "+n:"")},r.prototype._where_query=function(r,n,t,e){return this._query_data.push(t),this._sql+=" "+r+" "+n+(e?e:"=")+"?"},r.prototype.where=function(r,n,t){return this._where_query("WHERE",r,n,t)},r.prototype.or=function(r,n,t){return this._where_query("OR",r,n,t)},r.prototype.and=function(r,n,t){return this._where_query("AND",r,n,t)},r.prototype._where_in_query=function(r,n,t){return this._query_data=this._query_data.concat(t),this._sql+=" "+r+" "+n+" IN ("+o(t)+")"},r.prototype.where_in=function(r,n){return this._where_in_query("WHERE",r,n)},r.prototype.or_in=function(r,n){return this._where_in_query("OR",r,n)},r.prototype.and_in=function(r,n){return this._where_in_query("AND",r,n)},r.prototype._join_query=function(r,n,t,e,u){var o=t+(u?u:" = ")+e;return this._sql+=" "+r+" JOIN "+n+" ON "+o},r.prototype.join=function(r,n,t,e){return this._join_query("INNER",r,n,t,e)},r.prototype.left_join=function(r,n,t,e){return this._join_query("LEFT",r,n,t,e)},r.prototype.order_by=function(r,n){return this._sql+=" ORDER BY "+r+(n?" DESC":"")},r.prototype.group_by=function(r){return this._sql+=" GROUP BY "+r},r.prototype.having=function(r,n,t){return this._query_data.push(n),this._sql+=" HAVING "+r+(t?t:"=")+"?"},r.prototype.limit=function(r,n){return this._sql+=" LIMIT "+r+(n?" OFFSET "+n:"")},r.prototype.query=function(){return(new a).query(this._sql,this._query_data)},r.prototype.row=function(){return this._sql+=" LIMIT 1",(new a).query(this._sql,this._query_data)},r.prototype.col=function(){this._sql+=" LIMIT 1";var r=n.defer();return(new a).query(this._sql,this._query_data).then(function(n){r.resolve(n.length>0?n[0][Object.keys(n[0])[0]]:[])},r.reject),r.promise},r}(),f=function(r){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,r),n.prototype.__perform=function(r,t){var e=this,u=r,o={select:{from:function(){return e.from.apply(e,arguments)}},update:{set:function(){return e.set.apply(e,arguments)},where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)}},set:{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)}},"delete":{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)}},from:{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},join:function(){return e.join.apply(e,arguments)},left_join:function(){return e.left_join.apply(e,arguments)},order_by:function(){return e.order_by.apply(e,arguments)},group_by:function(){return e.group_by.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},where:{and:function(){return e.and.apply(e,arguments)},or:function(){return e.or.apply(e,arguments)},and_in:function(){return e.and_in.apply(e,arguments)},or_in:function(){return e.or_in.apply(e,arguments)},order_by:function(){return e.order_by.apply(e,arguments)},group_by:function(){return e.group_by.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},join:{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},join:function(){return e.join.apply(e,arguments)},left_join:function(){return e.left_join.apply(e,arguments)},order_by:function(){return e.order_by.apply(e,arguments)},group_by:function(){return e.group_by.apply(e,arguments)},having:function(){return e.having.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},group_by:{order_by:function(){return e.order_by.apply(e,arguments)},having:function(){return e.having.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},order_by:{having:function(){return e.having.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},having:{and:function(){return e.and.apply(e,arguments)},or:function(){return e.or.apply(e,arguments)},and_in:function(){return e.and_in.apply(e,arguments)},or_in:function(){return e.or_in.apply(e,arguments)},order_by:function(){return e.order_by.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},limit:{query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}}};switch(r){case"where":case"where_in":case"and":case"and_in":case"or":case"or_in":u="where";break;default:u=r}return n.__super__[r].apply(this,t),o[u]},n.prototype.select=function(){return this.__perform("select",arguments)},n.prototype.update=function(){return this.__perform("update",arguments)},n.prototype.set=function(){return this.__perform("set",arguments)},n.prototype.delete=function(){return this.__perform("delete",arguments)},n.prototype.from=function(){return this.__perform("from",arguments)},n.prototype.where=function(){return this.__perform("where",arguments)},n.prototype.where_in=function(){return this.__perform("where_in",arguments)},n.prototype.or=function(){return this.__perform("or",arguments)},n.prototype.and=function(){return this.__perform("and",arguments)},n.prototype.or_in=function(){return this.__perform("or_in",arguments)},n.prototype.and_in=function(){return this.__perform("and_in",arguments)},n.prototype.join=function(){return this.__perform("join",arguments)},n.prototype.left_join=function(){return this.__perform("join",arguments)},n.prototype.order_by=function(){return this.__perform("order_by",arguments)},n.prototype.group_by=function(){return this.__perform("group_by",arguments)},n.prototype.having=function(){return this.__perform("having",arguments)},n.prototype.limit=function(){return this.__perform("limit",arguments)},n.prototype.query=n.__super__.query,n.prototype.row=n.__super__.row,n.prototype.col=n.__super__.col,n}(_),l={select:function(r){return(new f).select(r)},update:function(r,n){return(new f).update(r,n)},insert:function(r,n){return(new y).insert(r,n)},batch_insert:function(r,n){return"string"!=typeof r?!1:n instanceof Array==!1?!1:(new y).batch_insert(r,n)},"delete":function(r){return(new f).delete(r)},query:function(r,n){return(new a).query(r,n?n:[])},create_table:function(r,n){return(new s).create(r,n)},drop_table:function(r){return(new c).drop(r)}};return r&&r.PARAMS&&r.TABLES_SQL?p(r.PARAMS,r.TABLES_SQL,r.CLEAR):(console.error("wSQL.config is not correct"),!1)}]);