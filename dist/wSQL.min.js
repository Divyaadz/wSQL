angular.module("wSQL",["wSQL.config"]).factory("wSQL",["W_SQL_CONFIG","$q",function(r,e){var t=function(r,e){function t(){this.constructor=r}for(var u in e)n.call(e,u)&&(r[u]=e[u]);return t.prototype=e.prototype,r.prototype=new t,r.__super__=e.prototype,r},n={}.hasOwnProperty,u=function(r){var e=0,t="",n="",u="",o=[];for(var i in r)t+=0==e?"?":",?",n+=(0==e?"? as ":",? as ")+i,u+=(0==e?"":",")+i+"=?",o.push(r[i]),++e;return{keys:Object.keys(r).join(),values:o,query:t,query_with_as:n,query_for_set:u}},o=function(r){var e="";return r.forEach(function(r,t){e+=0===t?"?":", ?"}),e},i=function(r,e){return r.replace(/\?/g,function(){var r=0;return function(){var t=e[r];return r++,"'"+t+"'"}}())},a=function(e){return r.DEBUG_LEVEL&&r.DEBUG_LEVEL>=e},p=function(r){switch(r){case"error":return a(1);case"warn":return a(2);case"info":return a(3);case"log":case"debug":return a(4);default:return!1}},s=function(){var r,e=!1;return{get:function(){return r},set:function(t){return r=window.openDatabase(t.name,t.version,t.sub_name,t.size),e=!0,r}}}(),c=function(r,t,n){if(!r.name||!r.version||!r.sub_name||!r.size||!t||Object.keys(t).length<=0)return p("error")&&console.error("WebSQLite InitInterface error: initialize params are not specified"),!1;if(s.set(r),n){p("warn")&&console.warn("DB was cleaned");var u=[];for(var o in t)u.push((new f).drop(o));e.all(u).then(function(){for(var r in t)(new y).create(r,t[r])})}else{p("warn")&&console.warn("DB was NOT cleaned");for(var o in t)(new y).create(o,t[o])}return g},_=function(){function r(){}return r.prototype._querySuccess=function(r,e,t){p("debug")&&console.debug("querySuccess");try{return e.insertId,t({insertId:e.insertId})}catch(n){var u=e.rows.length,o=[];if(e.rows.length>0)for(var i=0;u>i;i++)o[i]=JSON.parse(JSON.stringify(e.rows.item(i)));return t?t(o):!0}},r.prototype._queryDB=function(r,e,t,n){var u=this;p("info")&&console.info(i(e,t)),r.executeSql(e,t,function(r,e){u._querySuccess(r,e,n)},function(r){u._errorCB(r,e,t,n)})},r.prototype._errorCB=function(r,e,t,n){p("error")&&console.error("Error processing SQL, error & sql below:"),p("error")&&console.error(r),n&&n({error:r})},r.prototype.query=function(r,t){var n=e.defer(),u=this;return s.get().transaction(function(e){u._queryDB(e,r,t||[],n.resolve)},function(e){u._errorCB(e,r,n.reject)}),n.promise},r}(),y=function(){function r(){}return r.prototype.create=function(r,e){return(new _).query("CREATE TABLE IF NOT EXISTS "+r+"("+e.join()+")",[])},r}(),f=function(){function r(){}return r.prototype.drop=function(r){return(new _).query("DROP TABLE IF EXISTS "+r,[])},r}(),l=function(){function r(){}var t=900;return r.prototype.slice_data=function(r){for(var e=[],n=Math.floor(t/Object.keys(r[0]).length),u=Math.ceil(r.length/n),o=0;u>o;o++)e.push(r.slice(o*n,o*n+n));return e},r.prototype.check_data_length=function(r){return r.length*Object.keys(r[0]).length>t?this.slice_data(r):!1},r.prototype.insert=function(r,e){var t=u(e),n="INSERT INTO "+r+" ("+t.keys+") VALUES ("+t.query+")";return(new _).query(n,t.values)},r.prototype.batch_insert_by_slice=function(r,t,n){console.log("batch_insert_by_slice");var u=e.defer(),o=this,i=[];return t.forEach(function(e){i.push(o.batch_insert_query(r,e,n))}),e.all(i).then(function(r){var e={insertIds:[]};r.forEach(function(r){e.insertId=r.insertId,e.insertIds.push(r.insertId)}),u.resolve(e)},u.reject),u.promise},r.prototype.batch_insert_query=function(r,e,t){var n="INSERT"+(t?" OR IGNORE":"")+" INTO "+r+" ("+u(e[0]).keys+")",o=[];return e.forEach(function(r,e){var t=u(r);o=o.concat(t.values),n+=0===e?" SELECT "+t.query_with_as:" UNION SELECT "+t.query}),(new _).query(n,o)},r.prototype.batch_insert=function(r,e,t){var n=this.check_data_length(e);return console.log("slice_result"),console.log(n),n?this.batch_insert_by_slice(r,n,t):this.batch_insert_query(r,e,t)},r}(),h=function(){function r(){this._sql="",this._query_data=[],this._where_flag=!1}return r.prototype.select=function(r){return this._sql="SELECT "+(r?r:"*")},r.prototype.update=function(r,e){return this._sql="UPDATE "+r,e?this.set(e):this._sql},r.prototype.set=function(r){var e=u(r);return this._query_data=e.values,this._sql+=" SET "+e.query_for_set},r.prototype.delete=function(r){return this._sql="DELETE FROM "+r},r.prototype.from=function(r,e){return this._sql+=" FROM "+r+(e?" AS "+e:"")},r.prototype._where_query=function(r,e,t,n){return this._query_data.push(t),this._sql+=" "+r+" "+e+(n?n:"=")+"?"},r.prototype.where=function(r,e,t){return this._where_query(this._where_flag?"AND":"WHERE",r,e,t),this._where_flag=!0,this._sql},r.prototype._like_query=function(r,e,t,n){var u="%"+t+"%";switch(n){case"before":u="%"+t;break;case"after":u=t+"%";break;case"both":u="%"+t+"%";break;case!1:u=t;break;default:u="%"+t+"%"}return this._query_data.push(u),this._sql+=" "+r+" "+e+" LIKE ?"},r.prototype.like=function(r,e,t){return this._like_query(this._where_flag?"AND":"WHERE",r,e,t),this._where_flag=!0,this._sql},r.prototype.or_like=function(r,e,t){return this._like_query("OR",r,e,t)},r.prototype.and_like=function(r,e,t){return this.like(r,e,t)},r.prototype.or=function(r,e,t){return this._where_query("OR",r,e,t)},r.prototype.and=function(r,e,t){return this._where_query("AND",r,e,t)},r.prototype._where_in_query=function(r,e,t){return this._query_data=this._query_data.concat(t),this._sql+=" "+r+" "+e+" IN ("+o(t)+")"},r.prototype.where_in=function(r,e){return this._where_in_query("WHERE",r,e)},r.prototype.or_in=function(r,e){return this._where_in_query("OR",r,e)},r.prototype.and_in=function(r,e){return this._where_in_query("AND",r,e)},r.prototype._join_query=function(r,e,t,n,u){var o=t+(u?u:" = ")+n;return this._sql+=" "+r+" JOIN "+e+" ON "+o},r.prototype.join=function(r,e,t,n){return this._join_query("INNER",r,e,t,n)},r.prototype.left_join=function(r,e,t,n){return this._join_query("LEFT",r,e,t,n)},r.prototype.order_by=function(r,e){return this._sql+=" ORDER BY "+r+(e?" DESC":"")},r.prototype.group_by=function(r){return this._sql+=" GROUP BY "+r},r.prototype.having=function(r,e,t){return this._query_data.push(e),this._sql+=" HAVING "+r+(t?t:"=")+"?"},r.prototype.limit=function(r,e){return this._sql+=" LIMIT "+r+(e?" OFFSET "+e:"")},r.prototype.query=function(){return(new _).query(this._sql,this._query_data)},r.prototype.row=function(){return this._sql+=" LIMIT 1",(new _).query(this._sql,this._query_data)},r.prototype.col=function(){this._sql+=" LIMIT 1";var r=e.defer();return(new _).query(this._sql,this._query_data).then(function(e){r.resolve(e.length>0?e[0][Object.keys(e[0])[0]]:[])},r.reject),r.promise},r}(),m=function(r){function e(){return e.__super__.constructor.apply(this,arguments)}return t(e,r),e.prototype.__perform=function(r,t){var n=this,u=r,o={select:{from:function(){return n.from.apply(n,arguments)}},update:{set:function(){return n.set.apply(n,arguments)},where:function(){return n.where.apply(n,arguments)},where_in:function(){return n.where_in.apply(n,arguments)},like:function(){return n.like.apply(n,arguments)},query:function(){return n.query.apply(n,arguments)}},set:{where:function(){return n.where.apply(n,arguments)},where_in:function(){return n.where_in.apply(n,arguments)},like:function(){return n.like.apply(n,arguments)},query:function(){return n.query.apply(n,arguments)}},"delete":{where:function(){return n.where.apply(n,arguments)},where_in:function(){return n.where_in.apply(n,arguments)},like:function(){return n.like.apply(n,arguments)},query:function(){return n.query.apply(n,arguments)}},from:{where:function(){return n.where.apply(n,arguments)},where_in:function(){return n.where_in.apply(n,arguments)},like:function(){return n.like.apply(n,arguments)},join:function(){return n.join.apply(n,arguments)},left_join:function(){return n.left_join.apply(n,arguments)},order_by:function(){return n.order_by.apply(n,arguments)},group_by:function(){return n.group_by.apply(n,arguments)},limit:function(){return n.limit.apply(n,arguments)},query:function(){return n.query.apply(n,arguments)},row:function(){return n.row.apply(n,arguments)},col:function(){return n.col.apply(n,arguments)}},where:{where:function(){return n.where.apply(n,arguments)},and:function(){return n.and.apply(n,arguments)},or:function(){return n.or.apply(n,arguments)},and_in:function(){return n.and_in.apply(n,arguments)},or_in:function(){return n.or_in.apply(n,arguments)},like:function(){return n.like.apply(n,arguments)},and_like:function(){return n.and_like.apply(n,arguments)},or_like:function(){return n.or_like.apply(n,arguments)},order_by:function(){return n.order_by.apply(n,arguments)},group_by:function(){return n.group_by.apply(n,arguments)},limit:function(){return n.limit.apply(n,arguments)},query:function(){return n.query.apply(n,arguments)},row:function(){return n.row.apply(n,arguments)},col:function(){return n.col.apply(n,arguments)}},join:{where:function(){return n.where.apply(n,arguments)},where_in:function(){return n.where_in.apply(n,arguments)},like:function(){return n.like.apply(n,arguments)},join:function(){return n.join.apply(n,arguments)},left_join:function(){return n.left_join.apply(n,arguments)},order_by:function(){return n.order_by.apply(n,arguments)},group_by:function(){return n.group_by.apply(n,arguments)},having:function(){return n.having.apply(n,arguments)},limit:function(){return n.limit.apply(n,arguments)},query:function(){return n.query.apply(n,arguments)},row:function(){return n.row.apply(n,arguments)},col:function(){return n.col.apply(n,arguments)}},group_by:{order_by:function(){return n.order_by.apply(n,arguments)},having:function(){return n.having.apply(n,arguments)},limit:function(){return n.limit.apply(n,arguments)},query:function(){return n.query.apply(n,arguments)},row:function(){return n.row.apply(n,arguments)},col:function(){return n.col.apply(n,arguments)}},order_by:{having:function(){return n.having.apply(n,arguments)},limit:function(){return n.limit.apply(n,arguments)},query:function(){return n.query.apply(n,arguments)},row:function(){return n.row.apply(n,arguments)},col:function(){return n.col.apply(n,arguments)}},having:{and:function(){return n.and.apply(n,arguments)},or:function(){return n.or.apply(n,arguments)},and_in:function(){return n.and_in.apply(n,arguments)},or_in:function(){return n.or_in.apply(n,arguments)},and_like:function(){return n.and_like.apply(n,arguments)},or_like:function(){return n.or_like.apply(n,arguments)},order_by:function(){return n.order_by.apply(n,arguments)},limit:function(){return n.limit.apply(n,arguments)},query:function(){return n.query.apply(n,arguments)},row:function(){return n.row.apply(n,arguments)},col:function(){return n.col.apply(n,arguments)}},limit:{query:function(){return n.query.apply(n,arguments)},row:function(){return n.row.apply(n,arguments)},col:function(){return n.col.apply(n,arguments)}}};switch(r){case"where":case"where_in":case"and":case"and_in":case"or":case"or_in":case"like":case"and_like":case"or_like":u="where";break;default:u=r}return e.__super__[r].apply(this,t),o[u]},e.prototype.select=function(){return this.__perform("select",arguments)},e.prototype.update=function(){return this.__perform("update",arguments)},e.prototype.set=function(){return this.__perform("set",arguments)},e.prototype.delete=function(){return this.__perform("delete",arguments)},e.prototype.from=function(){return this.__perform("from",arguments)},e.prototype.where=function(){return this.__perform("where",arguments)},e.prototype.where_in=function(){return this.__perform("where_in",arguments)},e.prototype.or=function(){return this.__perform("or",arguments)},e.prototype.and=function(){return this.__perform("and",arguments)},e.prototype.or_in=function(){return this.__perform("or_in",arguments)},e.prototype.and_in=function(){return this.__perform("and_in",arguments)},e.prototype.like=function(){return this.__perform("like",arguments)},e.prototype.or_like=function(){return this.__perform("or_like",arguments)},e.prototype.and_like=function(){return this.__perform("and_like",arguments)},e.prototype.join=function(){return this.__perform("join",arguments)},e.prototype.left_join=function(){return this.__perform("join",arguments)},e.prototype.order_by=function(){return this.__perform("order_by",arguments)},e.prototype.group_by=function(){return this.__perform("group_by",arguments)},e.prototype.having=function(){return this.__perform("having",arguments)},e.prototype.limit=function(){return this.__perform("limit",arguments)},e.prototype.query=e.__super__.query,e.prototype.row=e.__super__.row,e.prototype.col=e.__super__.col,e}(h),g={select:function(r){return(new m).select(r)},update:function(r,e){return(new m).update(r,e)},insert:function(r,e){return(new l).insert(r,e)},batch_insert:function(r,e,t){return"string"!=typeof r?!1:e instanceof Array==!1?!1:(new l).batch_insert(r,e,t)},batch_insert_or_ignore:function(r,e){return this.batch_insert(r,e,!0)},"delete":function(r){return(new m).delete(r)},query:function(r,e){return(new _).query(r,e?e:[])},create_table:function(r,e){return(new y).create(r,e)},drop_table:function(r){return(new f).drop(r)}};return r&&r.PARAMS&&r.TABLES_SQL?c(r.PARAMS,r.TABLES_SQL,r.CLEAR):(p("error")&&console.error("wSQL.config is not correct"),!1)}]);