angular.module("wSQL",["wSQL.config"]).factory("wSQL",["W_SQL_CONFIG","$q",function(r,e){var n=function(r,e){function n(){this.constructor=r}for(var u in e)t.call(e,u)&&(r[u]=e[u]);return n.prototype=e.prototype,r.prototype=new n,r.__super__=e.prototype,r},t={}.hasOwnProperty,u=function(r){var e=0,n="",t="",u="",o=[];for(var i in r)n+=0==e?"?":",?",t+=(0==e?"? as ":",? as ")+i,u+=(0==e?"":",")+i+"=?",o.push(r[i]),++e;return{keys:Object.keys(r).join(),values:o,query:n,query_with_as:t,query_for_set:u}},o=function(r){var e="";return r.forEach(function(r,n){e+=0===n?"?":", ?"}),e},i=function(){var r,e=!1;return{get:function(){return r},set:function(n){return r=window.openDatabase(n.name,n.version,n.sub_name,n.size),e=!0,r}}}(),p=function(r,n,t){if(!r.name||!r.version||!r.sub_name||!r.size||!n||Object.keys(n).length<=0)return console.error("WebSQLite InitInterface error: initialize params are not specified"),!1;if(i.set(r),t){console.warn("DB was cleaned");var u=[];for(var o in n)u.push((new c).drop(o));e.all(u).then(function(){for(var r in n)(new s).create(r,n[r])})}else{console.warn("DB was NOT cleaned");for(var o in n)(new s).create(o,n[o])}return l},a=function(){function r(){}return r.prototype._querySuccess=function(r,e,n){console.debug("querySuccess");try{return e.insertId,n(JSON.parse(JSON.stringify(e)))}catch(t){var u=e.rows.length,o=[];if(e.rows.length>0)for(var i=0;u>i;i++)o[i]=JSON.parse(JSON.stringify(e.rows.item(i)));return n?n(o):!0}},r.prototype._queryDB=function(r,e,n,t){var u=this;console.info(e,n),r.executeSql(e,n,function(r,e){u._querySuccess(r,e,t)},function(r){u._errorCB(r,e,n,t)})},r.prototype._errorCB=function(r,e,n,t){console.error("Error processing SQL, error & sql below:"),console.error(r),t&&t({error:r})},r.prototype.query=function(r,n){var t=e.defer(),u=this;return i.get().transaction(function(e){u._queryDB(e,r,n||[],t.resolve)},function(e){u._errorCB(e,r,t.reject)}),t.promise},r}(),s=function(){function r(){}return r.prototype.create=function(r,e){return(new a).query("CREATE TABLE IF NOT EXISTS "+r+"("+e.join()+")",[])},r}(),c=function(){function r(){}return r.prototype.drop=function(r){return(new a).query("DROP TABLE IF EXISTS "+r,[])},r}(),_=function(){function r(){}return r.prototype.insert=function(r,e){var n=u(e),t="INSERT INTO "+r+" ("+n.keys+") VALUES ("+n.query+")";return(new a).query(t,n.values)},r.prototype.batch_insert=function(r,e,n){var t="INSERT"+(n?" OR IGNORE":"")+" INTO "+r+" ("+u(e[0]).keys+")",o=[];return e.forEach(function(r,e){var n=u(r);o=o.concat(n.values),t+=0===e?" SELECT "+n.query_with_as:" UNION SELECT "+n.query}),(new a).query(t,o)},r}(),y=function(){function r(){this._sql="",this._query_data=[],this._where_flag=!1}return r.prototype.select=function(r){return this._sql="SELECT "+(r?r:"*")},r.prototype.update=function(r,e){return this._sql="UPDATE "+r,e?this.set(e):this._sql},r.prototype.set=function(r){var e=u(r);return this._query_data=e.values,this._sql+=" SET "+e.query_for_set},r.prototype.delete=function(r){return this._sql="DELETE FROM "+r},r.prototype.from=function(r,e){return this._sql+=" FROM "+r+(e?" AS "+e:"")},r.prototype._where_query=function(r,e,n,t){return this._query_data.push(n),this._sql+=" "+r+" "+e+(t?t:"=")+"?"},r.prototype.where=function(r,e,n){return this._where_query(this._where_flag?"AND":"WHERE",r,e,n),this._where_flag=!0,this._sql},r.prototype._like_query=function(r,e,n,t){var u="%"+n+"%";switch(t){case"before":u="%"+n;break;case"after":u=n+"%";break;case"both":u="%"+n+"%";break;case!1:u=n;break;default:u="%"+n+"%"}return this._query_data.push(u),this._sql+=" "+r+" "+e+" LIKE ?"},r.prototype.like=function(r,e,n){return this._like_query(this._where_flag?"AND":"WHERE",r,e,n),this._where_flag=!0,this._sql},r.prototype.or_like=function(r,e,n){return this._like_query("OR",r,e,n)},r.prototype.and_like=function(r,e,n){return this.like(r,e,n)},r.prototype.or=function(r,e,n){return this._where_query("OR",r,e,n)},r.prototype.and=function(r,e,n){return this._where_query("AND",r,e,n)},r.prototype._where_in_query=function(r,e,n){return this._query_data=this._query_data.concat(n),this._sql+=" "+r+" "+e+" IN ("+o(n)+")"},r.prototype.where_in=function(r,e){return this._where_in_query("WHERE",r,e)},r.prototype.or_in=function(r,e){return this._where_in_query("OR",r,e)},r.prototype.and_in=function(r,e){return this._where_in_query("AND",r,e)},r.prototype._join_query=function(r,e,n,t,u){var o=n+(u?u:" = ")+t;return this._sql+=" "+r+" JOIN "+e+" ON "+o},r.prototype.join=function(r,e,n,t){return this._join_query("INNER",r,e,n,t)},r.prototype.left_join=function(r,e,n,t){return this._join_query("LEFT",r,e,n,t)},r.prototype.order_by=function(r,e){return this._sql+=" ORDER BY "+r+(e?" DESC":"")},r.prototype.group_by=function(r){return this._sql+=" GROUP BY "+r},r.prototype.having=function(r,e,n){return this._query_data.push(e),this._sql+=" HAVING "+r+(n?n:"=")+"?"},r.prototype.limit=function(r,e){return this._sql+=" LIMIT "+r+(e?" OFFSET "+e:"")},r.prototype.query=function(){return(new a).query(this._sql,this._query_data)},r.prototype.row=function(){return this._sql+=" LIMIT 1",(new a).query(this._sql,this._query_data)},r.prototype.col=function(){this._sql+=" LIMIT 1";var r=e.defer();return(new a).query(this._sql,this._query_data).then(function(e){r.resolve(e.length>0?e[0][Object.keys(e[0])[0]]:[])},r.reject),r.promise},r}(),f=function(r){function e(){return e.__super__.constructor.apply(this,arguments)}return n(e,r),e.prototype.__perform=function(r,n){var t=this,u=r,o={select:{from:function(){return t.from.apply(t,arguments)}},update:{set:function(){return t.set.apply(t,arguments)},where:function(){return t.where.apply(t,arguments)},where_in:function(){return t.where_in.apply(t,arguments)},like:function(){return t.like.apply(t,arguments)},query:function(){return t.query.apply(t,arguments)}},set:{where:function(){return t.where.apply(t,arguments)},where_in:function(){return t.where_in.apply(t,arguments)},like:function(){return t.like.apply(t,arguments)},query:function(){return t.query.apply(t,arguments)}},"delete":{where:function(){return t.where.apply(t,arguments)},where_in:function(){return t.where_in.apply(t,arguments)},like:function(){return t.like.apply(t,arguments)},query:function(){return t.query.apply(t,arguments)}},from:{where:function(){return t.where.apply(t,arguments)},where_in:function(){return t.where_in.apply(t,arguments)},like:function(){return t.like.apply(t,arguments)},join:function(){return t.join.apply(t,arguments)},left_join:function(){return t.left_join.apply(t,arguments)},order_by:function(){return t.order_by.apply(t,arguments)},group_by:function(){return t.group_by.apply(t,arguments)},limit:function(){return t.limit.apply(t,arguments)},query:function(){return t.query.apply(t,arguments)},row:function(){return t.row.apply(t,arguments)},col:function(){return t.col.apply(t,arguments)}},where:{where:function(){return t.where.apply(t,arguments)},and:function(){return t.and.apply(t,arguments)},or:function(){return t.or.apply(t,arguments)},and_in:function(){return t.and_in.apply(t,arguments)},or_in:function(){return t.or_in.apply(t,arguments)},like:function(){return t.like.apply(t,arguments)},and_like:function(){return t.and_like.apply(t,arguments)},or_like:function(){return t.or_like.apply(t,arguments)},order_by:function(){return t.order_by.apply(t,arguments)},group_by:function(){return t.group_by.apply(t,arguments)},limit:function(){return t.limit.apply(t,arguments)},query:function(){return t.query.apply(t,arguments)},row:function(){return t.row.apply(t,arguments)},col:function(){return t.col.apply(t,arguments)}},join:{where:function(){return t.where.apply(t,arguments)},where_in:function(){return t.where_in.apply(t,arguments)},like:function(){return t.like.apply(t,arguments)},join:function(){return t.join.apply(t,arguments)},left_join:function(){return t.left_join.apply(t,arguments)},order_by:function(){return t.order_by.apply(t,arguments)},group_by:function(){return t.group_by.apply(t,arguments)},having:function(){return t.having.apply(t,arguments)},limit:function(){return t.limit.apply(t,arguments)},query:function(){return t.query.apply(t,arguments)},row:function(){return t.row.apply(t,arguments)},col:function(){return t.col.apply(t,arguments)}},group_by:{order_by:function(){return t.order_by.apply(t,arguments)},having:function(){return t.having.apply(t,arguments)},limit:function(){return t.limit.apply(t,arguments)},query:function(){return t.query.apply(t,arguments)},row:function(){return t.row.apply(t,arguments)},col:function(){return t.col.apply(t,arguments)}},order_by:{having:function(){return t.having.apply(t,arguments)},limit:function(){return t.limit.apply(t,arguments)},query:function(){return t.query.apply(t,arguments)},row:function(){return t.row.apply(t,arguments)},col:function(){return t.col.apply(t,arguments)}},having:{and:function(){return t.and.apply(t,arguments)},or:function(){return t.or.apply(t,arguments)},and_in:function(){return t.and_in.apply(t,arguments)},or_in:function(){return t.or_in.apply(t,arguments)},and_like:function(){return t.and_like.apply(t,arguments)},or_like:function(){return t.or_like.apply(t,arguments)},order_by:function(){return t.order_by.apply(t,arguments)},limit:function(){return t.limit.apply(t,arguments)},query:function(){return t.query.apply(t,arguments)},row:function(){return t.row.apply(t,arguments)},col:function(){return t.col.apply(t,arguments)}},limit:{query:function(){return t.query.apply(t,arguments)},row:function(){return t.row.apply(t,arguments)},col:function(){return t.col.apply(t,arguments)}}};switch(r){case"where":case"where_in":case"and":case"and_in":case"or":case"or_in":case"like":case"and_like":case"or_like":u="where";break;default:u=r}return e.__super__[r].apply(this,n),o[u]},e.prototype.select=function(){return this.__perform("select",arguments)},e.prototype.update=function(){return this.__perform("update",arguments)},e.prototype.set=function(){return this.__perform("set",arguments)},e.prototype.delete=function(){return this.__perform("delete",arguments)},e.prototype.from=function(){return this.__perform("from",arguments)},e.prototype.where=function(){return this.__perform("where",arguments)},e.prototype.where_in=function(){return this.__perform("where_in",arguments)},e.prototype.or=function(){return this.__perform("or",arguments)},e.prototype.and=function(){return this.__perform("and",arguments)},e.prototype.or_in=function(){return this.__perform("or_in",arguments)},e.prototype.and_in=function(){return this.__perform("and_in",arguments)},e.prototype.like=function(){return this.__perform("like",arguments)},e.prototype.or_like=function(){return this.__perform("or_like",arguments)},e.prototype.and_like=function(){return this.__perform("and_like",arguments)},e.prototype.join=function(){return this.__perform("join",arguments)},e.prototype.left_join=function(){return this.__perform("join",arguments)},e.prototype.order_by=function(){return this.__perform("order_by",arguments)},e.prototype.group_by=function(){return this.__perform("group_by",arguments)},e.prototype.having=function(){return this.__perform("having",arguments)},e.prototype.limit=function(){return this.__perform("limit",arguments)},e.prototype.query=e.__super__.query,e.prototype.row=e.__super__.row,e.prototype.col=e.__super__.col,e}(y),l={select:function(r){return(new f).select(r)},update:function(r,e){return(new f).update(r,e)},insert:function(r,e){return(new _).insert(r,e)},batch_insert:function(r,e,n){return"string"!=typeof r?!1:e instanceof Array==!1?!1:(new _).batch_insert(r,e,n)},batch_insert_or_ignore:function(r,e){return this.batch_insert(r,e,!0)},"delete":function(r){return(new f).delete(r)},query:function(r,e){return(new a).query(r,e?e:[])},create_table:function(r,e){return(new s).create(r,e)},drop_table:function(r){return(new c).drop(r)}};return r&&r.PARAMS&&r.TABLES_SQL?p(r.PARAMS,r.TABLES_SQL,r.CLEAR):(console.error("wSQL.config is not correct"),!1)}]);