angular.module("wSQL",["wSQL.config"]).factory("wSQL",["W_SQL_CONFIG","$q",function(r,n){var t=function(r,n){function t(){this.constructor=r}for(var u in n)e.call(n,u)&&(r[u]=n[u]);return t.prototype=n.prototype,r.prototype=new t,r.__super__=n.prototype,r},e={}.hasOwnProperty,u=function(r){var n=0,t="",e="",u="",o=[];for(var i in r)t+=0==n?"?":",?",e+=(0==n?"? as ":",? as ")+i,u+=(0==n?"":",")+i+"=?",o.push(r[i]),++n;return{keys:Object.keys(r).join(),values:o,query:t,query_with_as:e,query_for_set:u}},o=function(r){var n="";return r.forEach(function(r,t){n+=0===t?"?":", ?"}),n},i=function(r,n){return r.replace(/\?/g,function(){var r=0;return function(){var t=n[r];return r++,"'"+t+"'"}}())},a=function(n){return r.DEBUG_LEVEL&&r.DEBUG_LEVEL>=n},p=function(r){switch(r){case"error":return a(1);case"warn":return a(2);case"info":return a(3);case"log":case"debug":return a(4);default:return!1}},s=function(){var r,n=!1;return{get:function(){return r},set:function(t){return r=window.openDatabase(t.name,t.version,t.sub_name,t.size),n=!0,r}}}(),_=function(r,t,e){if(!r.name||!r.version||!r.sub_name||!r.size||!t||Object.keys(t).length<=0)return p("error")&&console.error("WebSQLite InitInterface error: initialize params are not specified"),!1;if(s.set(r),e){p("warn")&&console.warn("DB was cleaned");var u=[];for(var o in t)u.push((new y).drop(o));n.all(u).then(function(){for(var r in t)(new f).create(r,t[r])})}else{p("warn")&&console.warn("DB was NOT cleaned");for(var o in t)(new f).create(o,t[o])}return g},c=function(){function r(){}return r.prototype._querySuccess=function(r,n,t){p("debug")&&console.debug("querySuccess");try{return n.insertId,t({insertId:n.insertId})}catch(e){var u=n.rows.length,o=[];if(n.rows.length>0)for(var i=0;u>i;i++)o[i]=JSON.parse(JSON.stringify(n.rows.item(i)));return t?t(o):!0}},r.prototype._queryDB=function(r,n,t,e){var u=this;p("info")&&console.info(i(n,t)),r.executeSql(n,t,function(r,n){u._querySuccess(r,n,e)},function(r){u._errorCB(r,n,t,e)})},r.prototype._errorCB=function(r,n,t,e){p("error")&&console.error("Error processing SQL, error & sql below:"),p("error")&&console.error(r),e&&e({error:r})},r.prototype.query=function(r,t){var e=n.defer(),u=this;return s.get().transaction(function(n){u._queryDB(n,r,t||[],e.resolve)},function(n){u._errorCB(n,r,e.reject)}),e.promise},r}(),f=function(){function r(){}return r.prototype.create=function(r,n){return(new c).query("CREATE TABLE IF NOT EXISTS "+r+"("+n.join()+")",[])},r}(),y=function(){function r(){}return r.prototype.drop=function(r){return(new c).query("DROP TABLE IF EXISTS "+r,[])},r}(),l=function(){function r(){}var t=900;return r.prototype.slice_data=function(r){for(var n=[],e=Math.floor(t/Object.keys(r[0]).length),u=Math.ceil(r.length/e),o=0;u>o;o++)n.push(r.slice(o*e,o*e+e));return n},r.prototype.check_data_length=function(r){return r.length*Object.keys(r[0]).length>t?this.slice_data(r):!1},r.prototype.insert=function(r,n){var t=u(n),e="INSERT INTO "+r+" ("+t.keys+") VALUES ("+t.query+")";return(new c).query(e,t.values)},r.prototype.batch_insert_by_slice=function(r,t,e){console.log("batch_insert_by_slice");var u=n.defer(),o=this,i=[];return t.forEach(function(n){i.push(o.batch_insert_query(r,n,e))}),n.all(i).then(function(r){var n={insertIds:[]};r.forEach(function(r){n.insertId=r.insertId,n.insertIds.push(r.insertId)}),u.resolve(n)},u.reject),u.promise},r.prototype.batch_insert_query=function(r,n,t){var e="INSERT"+(t?" OR IGNORE":"")+" INTO "+r+" ("+u(n[0]).keys+")",o=[];return n.forEach(function(r,n){var t=u(r);o=o.concat(t.values),e+=0===n?" SELECT "+t.query_with_as:" UNION SELECT "+t.query}),(new c).query(e,o)},r.prototype.batch_insert=function(r,n,t){var e=this.check_data_length(n);return console.log("slice_result"),console.log(e),e?this.batch_insert_by_slice(r,e,t):this.batch_insert_query(r,n,t)},r}(),h=function(){function r(){this._sql="",this._query_data=[],this._where_flag=!1}return r.prototype.select=function(r){return this._sql="SELECT "+(r?r:"*")},r.prototype.update=function(r,n){return this._sql="UPDATE "+r,n?this.set(n):this._sql},r.prototype.set=function(r){var n=u(r);return this._query_data=n.values,this._sql+=" SET "+n.query_for_set},r.prototype.delete=function(r){return this._sql="DELETE FROM "+r},r.prototype.from=function(r,n){return this._sql+=" FROM "+r+(n?" AS "+n:"")},r.prototype._where_query=function(r,n,t,e){return this._query_data.push(t),this._sql+=" "+r+" "+n+(e?e:"=")+"?"},r.prototype.where=function(r,n,t){return this._where_query(this._where_flag?"AND":"WHERE",r,n,t),this._where_flag=!0,this._sql},r.prototype._like_query=function(r,n,t,e){var u="%"+t+"%";switch(e){case"before":u="%"+t;break;case"after":u=t+"%";break;case"both":u="%"+t+"%";break;case!1:u=t;break;default:u="%"+t+"%"}return this._query_data.push(u),this._sql+=" "+r+" "+n+" LIKE ?"},r.prototype.like=function(r,n,t){return this._like_query(this._where_flag?"AND":"WHERE",r,n,t),this._where_flag=!0,this._sql},r.prototype.or_like=function(r,n,t){return this._like_query("OR",r,n,t)},r.prototype.and_like=function(r,n,t){return this.like(r,n,t)},r.prototype.or=function(r,n,t){return this._where_query("OR",r,n,t)},r.prototype.and=function(r,n,t){return this._where_query("AND",r,n,t)},r.prototype._where_in_query=function(r,n,t,e){return this._query_data=this._query_data.concat(t),this._where_flag=!0,this._sql+=" "+r+" "+n+(e?" NOT IN ":" IN ")+"("+o(t)+")"},r.prototype.where_in=function(r,n,t){return this._where_in_query(this._where_flag?"AND":"WHERE",r,n,t)},r.prototype.where_not_in=function(r,n){return this.where_in(r,n,!0)},r.prototype.or_in=function(r,n,t){return this._where_in_query("OR",r,n,t)},r.prototype.or_not_in=function(r,n){return this.or_in(r,n,!0)},r.prototype.and_in=function(r,n,t){return this._where_in_query("AND",r,n,t)},r.prototype.and_not_in=function(r,n){return this.and_in(r,n,!0)},r.prototype._join_query=function(r,n,t,e,u){var o=t+(u?u:" = ")+e;return this._sql+=" "+r+" JOIN "+n+" ON "+o},r.prototype.join=function(r,n,t,e){return this._join_query("INNER",r,n,t,e)},r.prototype.left_join=function(r,n,t,e){return this._join_query("LEFT",r,n,t,e)},r.prototype.order_by=function(r,n){return this._sql+=" ORDER BY "+r+(n?" DESC":"")},r.prototype.group_by=function(r){return this._sql+=" GROUP BY "+r},r.prototype.having=function(r,n,t){return this._query_data.push(n),this._sql+=" HAVING "+r+(t?t:"=")+"?"},r.prototype.limit=function(r,n){return this._sql+=" LIMIT "+r+(n?" OFFSET "+n:"")},r.prototype.query=function(){return(new c).query(this._sql,this._query_data)},r.prototype.row=function(){return this._sql+=" LIMIT 1",(new c).query(this._sql,this._query_data)},r.prototype.col=function(){this._sql+=" LIMIT 1";var r=n.defer();return(new c).query(this._sql,this._query_data).then(function(n){r.resolve(n.length>0?n[0][Object.keys(n[0])[0]]:[])},r.reject),r.promise},r}(),m=function(r){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,r),n.prototype.__perform=function(r,t){var e=this,u=r,o={select:{from:function(){return e.from.apply(e,arguments)}},update:{set:function(){return e.set.apply(e,arguments)},where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},where_not_in:function(){return e.where_not_in.apply(e,arguments)},like:function(){return e.like.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)}},set:{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},where_not_in:function(){return e.where_not_in.apply(e,arguments)},like:function(){return e.like.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)}},"delete":{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},where_not_in:function(){return e.where_not_in.apply(e,arguments)},like:function(){return e.like.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)}},from:{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},where_not_in:function(){return e.where_not_in.apply(e,arguments)},like:function(){return e.like.apply(e,arguments)},join:function(){return e.join.apply(e,arguments)},left_join:function(){return e.left_join.apply(e,arguments)},order_by:function(){return e.order_by.apply(e,arguments)},group_by:function(){return e.group_by.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},where:{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},where_not_in:function(){return e.where_not_in.apply(e,arguments)},and:function(){return e.and.apply(e,arguments)},or:function(){return e.or.apply(e,arguments)},and_in:function(){return e.and_in.apply(e,arguments)},and_not_in:function(){return e.and_not_in.apply(e,arguments)},or_in:function(){return e.or_in.apply(e,arguments)},or_not_in:function(){return e.or_not_in.apply(e,arguments)},like:function(){return e.like.apply(e,arguments)},and_like:function(){return e.and_like.apply(e,arguments)},or_like:function(){return e.or_like.apply(e,arguments)},order_by:function(){return e.order_by.apply(e,arguments)},group_by:function(){return e.group_by.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},join:{where:function(){return e.where.apply(e,arguments)},where_in:function(){return e.where_in.apply(e,arguments)},where_not_in:function(){return e.where_not_in.apply(e,arguments)},like:function(){return e.like.apply(e,arguments)},join:function(){return e.join.apply(e,arguments)},left_join:function(){return e.left_join.apply(e,arguments)},order_by:function(){return e.order_by.apply(e,arguments)},group_by:function(){return e.group_by.apply(e,arguments)},having:function(){return e.having.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},group_by:{order_by:function(){return e.order_by.apply(e,arguments)},having:function(){return e.having.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},order_by:{having:function(){return e.having.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},having:{and:function(){return e.and.apply(e,arguments)},or:function(){return e.or.apply(e,arguments)},and_in:function(){return e.and_in.apply(e,arguments)},and_not_in:function(){return e.and_not_in.apply(e,arguments)},or_in:function(){return e.or_in.apply(e,arguments)},or_not_in:function(){return e.or_not_in.apply(e,arguments)},and_like:function(){return e.and_like.apply(e,arguments)},or_like:function(){return e.or_like.apply(e,arguments)},order_by:function(){return e.order_by.apply(e,arguments)},limit:function(){return e.limit.apply(e,arguments)},query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}},limit:{query:function(){return e.query.apply(e,arguments)},row:function(){return e.row.apply(e,arguments)},col:function(){return e.col.apply(e,arguments)}}};switch(r){case"where":case"where_in":case"where_not_in":case"and":case"and_in":case"and_not_in":case"or":case"or_in":case"or_not_in":case"like":case"and_like":case"or_like":u="where";break;default:u=r}return n.__super__[r].apply(this,t),o[u]},n.prototype.select=function(){return this.__perform("select",arguments)},n.prototype.update=function(){return this.__perform("update",arguments)},n.prototype.set=function(){return this.__perform("set",arguments)},n.prototype.delete=function(){return this.__perform("delete",arguments)},n.prototype.from=function(){return this.__perform("from",arguments)},n.prototype.where=function(){return this.__perform("where",arguments)},n.prototype.where_in=function(){return this.__perform("where_in",arguments)},n.prototype.where_not_in=function(){return this.__perform("where_not_in",arguments)},n.prototype.or=function(){return this.__perform("or",arguments)},n.prototype.and=function(){return this.__perform("and",arguments)},n.prototype.or_in=function(){return this.__perform("or_in",arguments)},n.prototype.or_not_in=function(){return this.__perform("or_not_in",arguments)},n.prototype.and_in=function(){return this.__perform("and_in",arguments)},n.prototype.and_not_in=function(){return this.__perform("and_not_in",arguments)},n.prototype.like=function(){return this.__perform("like",arguments)},n.prototype.or_like=function(){return this.__perform("or_like",arguments)},n.prototype.and_like=function(){return this.__perform("and_like",arguments)},n.prototype.join=function(){return this.__perform("join",arguments)},n.prototype.left_join=function(){return this.__perform("join",arguments)},n.prototype.order_by=function(){return this.__perform("order_by",arguments)},n.prototype.group_by=function(){return this.__perform("group_by",arguments)},n.prototype.having=function(){return this.__perform("having",arguments)},n.prototype.limit=function(){return this.__perform("limit",arguments)},n.prototype.query=n.__super__.query,n.prototype.row=n.__super__.row,n.prototype.col=n.__super__.col,n}(h),g={select:function(r){return(new m).select(r)},update:function(r,n){return(new m).update(r,n)},insert:function(r,n){return(new l).insert(r,n)},batch_insert:function(r,n,t){return"string"!=typeof r?!1:n instanceof Array==!1?!1:(new l).batch_insert(r,n,t)},batch_insert_or_ignore:function(r,n){return this.batch_insert(r,n,!0)},"delete":function(r){return(new m).delete(r)},query:function(r,n){return(new c).query(r,n?n:[])},create_table:function(r,n){return(new f).create(r,n)},drop_table:function(r){return(new y).drop(r)}};return r&&r.PARAMS&&r.TABLES_SQL?_(r.PARAMS,r.TABLES_SQL,r.CLEAR):(p("error")&&console.error("wSQL.config is not correct"),!1)}]);